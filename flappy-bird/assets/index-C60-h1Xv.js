var ut=Object.defineProperty;var dt=(i,t,r)=>t in i?ut(i,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):i[t]=r;var a=(i,t,r)=>(dt(i,typeof t!="symbol"?t+"":t,r),r);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function r(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(s){if(s.ep)return;s.ep=!0;const o=r(s);fetch(s.href,o)}})();const L=document.getElementById("debug-overlay");function v(i){L.append(i),L.append(`
`)}function lt(){L.innerHTML=""}function h(i,t){if(!i)throw new Error(t??"Assertion failed.")}let d,e;function ft(){d=document.getElementById("app"),d.oncontextmenu=t=>t.preventDefault();const i=d.getContext("webgl2",{desynchronized:!1,antialias:!0});h(i,"Failed to initialize WebGL 2"),e=i,e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!0),J()}function B(){return d.width}function l(){return d.height}function J(){const i=d.height/d.width,t=Math.min(d.width,window.innerWidth),r=t*i;d.style.width=`${t}px`,d.style.height=`${r}px`}let Z;function tt(i){J(),Z(i),requestAnimationFrame(tt)}function xt(i){Z=i,requestAnimationFrame(tt)}function T(){const i=e.createBuffer();return h(i,"Failed to create WebGL buffer"),i}function pt(){const i=e.createVertexArray();return h(i,"Failed to create WebGL vertex array"),i}function $(i,t){const r=e.getUniformLocation(i,t);return h(r,"Failed to get WebGL uniform location"),r}function gt(i,t){const r=e.createProgram();h(r,"Failed to create WebGL program");const n=H(e.VERTEX_SHADER,i),s=H(e.FRAGMENT_SHADER,t);e.attachShader(r,n),e.attachShader(r,s),e.linkProgram(r);const o=e.getProgramInfoLog(r);return o&&o.length>0&&console.log("Program linkage log: "+o),h(e.getProgramParameter(r,e.LINK_STATUS),"Failed to link program"),e.deleteShader(n),e.deleteShader(s),r}function H(i,t){const r=e.createShader(i);h(r,"Failed to create WebGL shader"),e.shaderSource(r,t),e.compileShader(r);const n=e.getShaderInfoLog(r);return n&&n.length>0&&console.log(`Shader compilation log: ${n}

Shader source: ${t}`),h(e.getShaderParameter(r,e.COMPILE_STATUS),"Failed to compile shader"),r}var et=(i=>(i[i.Left=0]="Left",i))(et||{});class rt{constructor(){a(this,"downFrame",0)}}const b=new Map,w=new Map;function mt(){for(const i of b)v(`Key down: ${i[0]} (frame ${i[1].downFrame})`);for(const i of w)v(`Mouse button down: ${i[0]} (frame ${i[1].downFrame})`)}function bt(i){let t=b.get(i.code);t||(t=new rt,t.downFrame=m,b.set(i.code,t))}function wt(i){b.delete(i.code)}function Et(i){let t=w.get(i.button);t||(t=new rt,t.downFrame=m,w.set(i.button,t))}function Tt(i){w.delete(i.button)}function Rt(){window.addEventListener("keydown",bt),window.addEventListener("keyup",wt),window.addEventListener("pointerdown",Et),window.addEventListener("pointerup",Tt)}function R(i){const t=b.get(i);return(t==null?void 0:t.downFrame)===m}function At(i){const t=w.get(i);return(t==null?void 0:t.downFrame)===m}const C=[];let x;function it(){const i=e.createTexture();return h(i,"Failed to create WebGL texture"),i}function M(){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST)}function yt(){x=it(),e.bindTexture(e.TEXTURE_2D,x),M(),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([255,255,255,255])),e.bindTexture(e.TEXTURE_2D,null)}function P(i){const t=it();e.bindTexture(e.TEXTURE_2D,x),M(),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([255,255,255,255])),e.bindTexture(e.TEXTURE_2D,null);const r=new Image;return r.onload=()=>{C.push({texture:t,image:r})},r.src=i,t}function vt(){for(const i of C){const t=i.image;e.bindTexture(e.TEXTURE_2D,i.texture),M(),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t.width,t.height,0,e.RGBA,e.UNSIGNED_BYTE,t)}e.bindTexture(e.TEXTURE_2D,null),C.length=0}const Bt=`#version 300 es\r
\r
layout(location = 0) in vec2 position;\r
layout(location = 1) in vec4 inColor;\r
layout(location = 2) in vec2 inTexCoord;\r
uniform vec2 viewportSize;\r
\r
out vec4 color;\r
out vec2 texCoord;\r
\r
void main() {\r
    gl_Position = vec4(\r
        position.x / (viewportSize.x / 2.0) - 1.0,\r
        position.y / (viewportSize.y / 2.0) - 1.0,\r
        1.0,\r
        1.0\r
    );\r
    color = inColor;\r
    texCoord = inTexCoord;\r
}\r
`,Ft=`#version 300 es\r
precision highp float;\r
\r
in vec4 color;\r
in vec2 texCoord;\r
uniform sampler2D currentTexture;\r
\r
out vec4 outColor;\r
\r
void main() {\r
    outColor = texture(currentTexture, texCoord) * color;\r
}\r
`,I=4,Ut=6,A=1024;let p=null,nt,st;function _t(){return p||(p=gt(Bt,Ft),nt=$(p,"viewportSize"),st=$(p,"currentTexture"),p)}class Dt{constructor(){a(this,"vao");a(this,"positionBuffer");a(this,"colorBuffer");a(this,"texCoordBuffer");a(this,"indexBuffer");a(this,"positions",new Float32Array(I*2*A));a(this,"colors",new Uint32Array(I*A));a(this,"texCoords",new Float32Array(I*2*A));a(this,"indices",new Uint16Array(Ut*A));a(this,"numVertices",0);a(this,"numIndices",0);a(this,"started",!1);a(this,"currentTexture",x);this.vao=pt(),this.positionBuffer=T(),this.colorBuffer=T(),this.texCoordBuffer=T(),this.indexBuffer=T(),e.bindVertexArray(this.vao),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferData(e.ARRAY_BUFFER,this.positions.length,e.DYNAMIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),e.bufferData(e.ARRAY_BUFFER,this.colors.length,e.DYNAMIC_DRAW),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,4,e.UNSIGNED_BYTE,!0,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.texCoordBuffer),e.bufferData(e.ARRAY_BUFFER,this.texCoords.length,e.DYNAMIC_DRAW),e.enableVertexAttribArray(2),e.vertexAttribPointer(2,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.indices.length,e.DYNAMIC_DRAW),e.bindVertexArray(null)}begin(){h(!this.started),this.started=!0}vertex(t,r,n,s,o){let c=this.numVertices*2;this.positions[c]=t,this.positions[c+1]=r,this.colors[this.numVertices]=o,this.texCoords[c]=n,this.texCoords[c+1]=s,++this.numVertices}quadIndices(){this.indices[this.numIndices++]=this.numVertices+0,this.indices[this.numIndices++]=this.numVertices+1,this.indices[this.numIndices++]=this.numVertices+2,this.indices[this.numIndices++]=this.numVertices+1,this.indices[this.numIndices++]=this.numVertices+2,this.indices[this.numIndices++]=this.numVertices+3}quadCorners(t,r,n,s,o){this.quadIndices(),this.vertex(t,r,0,0,o),this.vertex(t,s,0,1,o),this.vertex(n,r,1,0,o),this.vertex(n,s,1,1,o)}colorQuadCorners(t,r,n,s,o=4294967295){h(this.started),this.switchTexture(x),this.quadCorners(t,r,n,s,o)}colorQuad(t,r,n,s,o=4294967295){this.colorQuadCorners(t,r,t+n,r+s,o)}textureQuadCorners(t,r,n,s,o,c=4294967295){h(this.started),this.switchTexture(o),this.quadCorners(t,r,n,s,c)}textureQuad(t,r,n,s,o,c=4294967295){this.textureQuadCorners(t,r,t+n,r+s,o,c)}textureQuadTexCoord(t,r,n,s,o,c=4294967295){this.textureQuadCorners(t,r,t+n,r+s,o,c)}drawText(t,r,n,s,o=4294967295){if(h(this.started),s.length===0)return;this.switchTexture(n.texture);const c=256,E=1/c;for(let F=0;F<s.length;++F){const ht=s.charCodeAt(F),u=n.chars.get(ht);if(!u)continue;const U=t+u.offsetX,_=r-u.offsetY+n.base-u.height,V=U+u.width,W=_+u.height,D=u.x*E,S=(c-u.y-u.height)*E,Q=D+u.width*E,z=S+u.height*E;this.quadIndices(),this.vertex(U,_,D,S,o),this.vertex(U,W,D,z,o),this.vertex(V,_,Q,S,o),this.vertex(V,W,Q,z,o),t+=u.advanceX}}switchTexture(t){this.currentTexture!==t&&(this.commit(!0),this.currentTexture=t)}commit(t){h(this.started),this.numVertices>0&&(e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this.positions,0,this.numVertices*2),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this.colors,0,this.numVertices),e.bindBuffer(e.ARRAY_BUFFER,this.texCoordBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this.texCoords,0,this.numVertices*2),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,this.indices,0,this.numIndices),e.useProgram(_t()),e.uniform2f(nt,B(),l()),e.uniform1i(st,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.currentTexture),e.bindVertexArray(this.vao),e.drawElements(e.TRIANGLES,this.numIndices,e.UNSIGNED_SHORT,0),e.bindVertexArray(null),e.bindTexture(e.TEXTURE_2D,null)),this.numVertices=0,this.numIndices=0,this.started=!1,t&&this.begin()}end(){this.commit(!1),this.currentTexture=x}}function y(){return Math.random()*2**32>>>0}class O{constructor(t,r,n,s){this.a=t,this.b=r,this.c=n,this.d=s,h((t|r|n|s)!==0,"At least one value must be non-zero")}static newRandom(){let t=0,r=0,n=0,s=0;for(;!(t|r|n|s);)t=y(),r=y(),n=y(),s=y();return new O(t,r,n,s)}nextFloat(){let t=this.b<<9,r=this.b*5;return r=(r<<7|r>>>25)*9,this.c^=this.a,this.d^=this.b,this.b^=this.c,this.a^=this.d,this.c^=t,this.d=this.d<<11|this.d>>>21,(r>>>0)/4294967296}nextFloatBetween(t,r){return t+this.nextFloat()*(r-t)}}function St(i){const t=document.createElement("audio");return t.src=i,t}class It{constructor(t){a(this,"view");a(this,"offset",0);this.view=new DataView(t)}get done(){return this.offset>=this.view.byteLength}readInt16(){const t=this.view.getInt16(this.offset,!0);return this.offset+=2,t}readUint8(){const t=this.view.getUint8(this.offset);return this.offset+=1,t}readUint16(){const t=this.view.getUint16(this.offset,!0);return this.offset+=2,t}readUint32(){const t=this.view.getUint32(this.offset,!0);return this.offset+=4,t}}class Lt{constructor(t){a(this,"texture",x);a(this,"lineHeight",0);a(this,"base",0);a(this,"chars",new Map);fetch(t).then(r=>(h(r.ok),r.arrayBuffer())).then(this.load.bind(this)),this.texture=P("/flappy-bird/font_0.png")}load(t){const r=new It(t);for(h(r.readUint32()===54938946);!r.done;){const n=r.readUint8(),s=r.readUint32(),o=r.offset+s;switch(n){case 2:this.lineHeight=r.readUint16(),this.base=r.readUint16();break;case 4:for(;r.offset<o;){const c=r.readUint32();this.chars.set(c,{x:r.readUint16(),y:r.readUint16(),width:r.readUint16(),height:r.readUint16(),offsetX:r.readInt16(),offsetY:r.readInt16(),advanceX:r.readInt16()}),r.offset+=2}break}r.offset=o}console.log(this)}}let ot,at,ct,Y;function Ct(){ot=P("/flappy-bird/test.png"),at=P("/flappy-bird/obstacle.png"),ct=St("/flappy-bird/score.wav"),Y=new Lt("/flappy-bird/font.fnt")}class N{constructor(t=0,r=0,n=0,s=0){this.x=t,this.y=r,this.width=n,this.height=s}containsPoint(t,r){return t>=this.x&&t<=this.x+this.width&&r>=this.y&&r<=this.y+this.height}containsRect(t){return this.containsPoint(t.x,t.y)||this.containsPoint(t.x+t.width,t.y)||this.containsPoint(t.x,t.y+t.height)||this.containsPoint(t.x+t.width,t.y+t.height)}}const X=150,Pt=-900,f=20;class Yt{constructor(){a(this,"y",0);a(this,"vy",0);this.reset()}get x(){return X}reset(){this.y=(l()-f)/2,this.vy=0}calcRect(){return new N(this.x,this.y,f,f)}update(t,r){this.vy+=Pt*t,r&&(this.vy=400);let n=0;return this.y+=this.vy*t,this.y+f>=l()?(this.y=l()-f,this.vy=0):this.y<=0&&(this.y=0,this.vy=0,n=1),n}draw(t){t.textureQuad(this.x,this.y,f,f,ot)}}const k=180,Nt=-100,Mt=100;var g=(i=>(i[i.No=0]="No",i[i.Yes=1]="Yes",i))(g||{});class q{constructor(t,r){a(this,"x",0);a(this,"gapOffsetY",0);a(this,"scored",!1);this.x=t,this.reset(r)}get vx(){return-180}get centerX(){return this.x+this.width/2}get width(){return 70}containsRect(t){for(const r of this.calcRects())if(r.containsRect(t))return!0;return!1}calcRects(){const r=l()/2+this.gapOffsetY-k/2,n=r+k;return[new N(this.x,0,this.width,r),new N(this.x,n,this.width,l()-n)]}reset(t){this.gapOffsetY=t.nextFloatBetween(Nt,Mt),this.scored=!1}update(t){return this.x+=this.vx*t,!this.scored&&this.centerX<=X?(this.scored=!0,1):0}draw(t){for(const r of this.calcRects())t.textureQuad(r.x,r.y,r.width,r.height,at)}}const K=200,Ot=300;class Xt{constructor(t){a(this,"obstacles",[]);this.random=t,this.reset()}reset(){this.obstacles.length=0,this.obstacles.push(new q(X+Ot,this.random))}getNearestObstacle(t){let r=this.obstacles[0],n=1/0;for(const s of this.obstacles){const o=Math.abs(t-s.centerX);o<n&&(r=s,n=o)}return r}getFarthestObstacle(){let t=this.obstacles[0];for(let r=1;r<this.obstacles.length;++r){const n=this.obstacles[r];n.x>=t.x&&(t=n)}return t}reuseObstacle(t){t.x=this.getFarthestObstacle().x+K,t.reset(this.random)}spawnObstacles(){let t=this.getFarthestObstacle();for(;t.x<=B();)t=new q(t.x+K,this.random),this.obstacles.push(t)}update(t){let r=g.No;for(const n of this.obstacles)n.update(t)===g.Yes&&(h(r===g.No),r=g.Yes),n.x+n.width<0&&this.reuseObstacle(n);return r}draw(t){for(const r of this.obstacles)r.draw(t)}}class Gt{constructor(){a(this,"started",!1);a(this,"score",0);a(this,"died",!1);a(this,"spriteBatch",new Dt);a(this,"player",new Yt);a(this,"obstacleManager",new Xt(new O(100,200,300,400)));Ct(),this.reset()}reset(){this.died=!1,this.player.reset(),this.obstacleManager.reset(),this.started=!1,this.score=0}update(t){let r=R("Space")||R("Enter")||R("W")||R("ArrowUp")||At(et.Left);if(this.died){if(!r)return;r=!1,this.reset()}if(this.obstacleManager.spawnObstacles(),!this.started&&(this.started=r,!this.started))return;const n=this.player.update(t,r);this.obstacleManager.update(t)===g.Yes&&(this.score+=1,ct.play());const s=this.obstacleManager.getNearestObstacle(this.player.x);(n||s.containsRect(this.player.calcRect()))&&(this.died=!0)}draw(){this.spriteBatch.begin(),this.player.draw(this.spriteBatch),this.obstacleManager.draw(this.spriteBatch),this.died&&this.spriteBatch.colorQuad(100,100,B()-200,l()-200),this.spriteBatch.drawText(20,l()-20-Y.base,Y,`Score: ${this.score}`),this.spriteBatch.end()}}let m=0,G,j=performance.now()/1e3;function Vt(i){let t=i-j;t>1/20&&(t=1/20),j=i,v(`FPS: ${(1/t).toFixed(0)}`),mt(),vt(),G.update(t)}function Wt(i){lt(),v(`Frame: ${m}`),Vt(i/1e3),e.viewport(0,0,B(),l()),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT),G.draw(),++m}function Qt(){ft(),Rt(),yt(),G=new Gt,xt(Wt)}document.addEventListener("DOMContentLoaded",Qt);
